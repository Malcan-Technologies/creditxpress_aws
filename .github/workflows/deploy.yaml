name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            admin/package-lock.json

      # Build Frontend
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci --legacy-peer-deps

      - name: Build frontend application
        working-directory: ./frontend
        run: npm run build
        
      # Build Admin
      - name: Install admin dependencies
        working-directory: ./admin
        run: npm ci --legacy-peer-deps

      - name: Build admin application
        working-directory: ./admin
        run: npm run build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEYS }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Sync changed files
        run: |
          # Create a temporary directory for organizing files
          mkdir -p temp_deploy/frontend
          mkdir -p temp_deploy/admin
          mkdir -p temp_deploy/backend
          mkdir -p temp_deploy/config
          mkdir -p temp_deploy/scripts
          
          # Copy frontend files
          cp -r frontend/.next temp_deploy/frontend/
          cp -r frontend/public temp_deploy/frontend/
          cp frontend/package.json temp_deploy/frontend/
          cp frontend/package-lock.json temp_deploy/frontend/
          
          # Copy admin files
          cp -r admin/.next temp_deploy/admin/
          cp -r admin/public temp_deploy/admin/
          cp admin/package.json temp_deploy/admin/
          cp admin/package-lock.json temp_deploy/admin/
          
          # Copy backend files
          cp -r backend/src temp_deploy/backend/
          cp -r backend/prisma temp_deploy/backend/
          cp backend/package.json temp_deploy/backend/
          cp backend/package-lock.json temp_deploy/backend/
          cp backend/tsconfig.json temp_deploy/backend/
          cp backend/.env.example temp_deploy/backend/
          cp -r backend/docker-compose.prod.yml temp_deploy/backend/
          cp -r backend/Dockerfile.prod temp_deploy/backend/
          
          # Copy config and scripts
          cp config/nginx.conf temp_deploy/config/
          cp scripts/deploy.sh temp_deploy/scripts/
          
          # Create archive from the organized directory
          cd temp_deploy
          tar -czf ../deploy.tar.gz .
          cd ..
          
          # Clean up temporary directory
          rm -rf temp_deploy
          
          # Copy archive to server
          scp -i ~/.ssh/deploy_key deploy.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/
          
          # Extract and sync only changed files
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
            cd /var/www/growkapital
            mkdir -p /tmp/new-deploy
            cd /tmp/new-deploy
            tar xzf /tmp/deploy.tar.gz
            rsync -av --delete --exclude="node_modules" --exclude=".git" --exclude="node_modules_cache" . /var/www/growkapital/
            # Ensure proper permissions for Next.js static files
            chmod -R 755 /var/www/growkapital/frontend/.next/static
            chmod -R 755 /var/www/growkapital/frontend/public
            chmod -R 755 /var/www/growkapital/admin/.next/static
            chmod -R 755 /var/www/growkapital/admin/public
            touch /tmp/files-changed
            rm -rf /tmp/new-deploy /tmp/deploy.tar.gz
          '

      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEYS }}
          command_timeout: "15m"
          script: |
            cd /var/www/growkapital
            
            # Cleanup any leftover temporary files
            rm -rf /tmp/new-deploy /tmp/deploy.tar.gz node_modules_old
            
            # Memory optimization: Clear system cache
            sync && echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null
            
            # Deploy Backend
            cd backend
            
            # Create .env file from secrets
            echo "${{ secrets.BACKEND_ENV }}" > .env
            
            # Start or restart Docker containers
            echo "Deploying backend services..."
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d --build
            
            # Deploy Frontend
            cd ../frontend
            
            # Check if app is already running
            if pm2 list | grep -q "growkapital-frontend"; then
              echo "Frontend is running, restarting..."
              pm2 delete growkapital-frontend
            else
              echo "Frontend not running, will start fresh..."
            fi
            
            # Memory-efficient dependency management
            HASH_FILE="node_modules/.package-json-hash"
            CURRENT_HASH=$(md5sum package.json | cut -d' ' -f1)
            CACHED_HASH=$(cat $HASH_FILE 2>/dev/null || echo "")
            
            if [ ! -d "node_modules" ] || [ "$CURRENT_HASH" != "$CACHED_HASH" ]; then
              echo "Installing frontend dependencies..."
              NODE_OPTIONS="--max-old-space-size=512" npm ci --omit=dev --no-audit --no-fund --prefer-offline --legacy-peer-deps
              echo "$CURRENT_HASH" > "$HASH_FILE"
            else
              echo "Frontend dependencies are up to date, skipping installation"
            fi
            
            # Create .env file from secrets
            echo "${{ secrets.FRONTEND_ENV }}" > .env
            
            # Deploy Admin
            cd ../admin
            
            # Check if admin app is already running
            if pm2 list | grep -q "growkapital-admin"; then
              echo "Admin is running, restarting..."
              pm2 delete growkapital-admin
            else
              echo "Admin not running, will start fresh..."
            fi
            
            # Memory-efficient dependency management
            HASH_FILE="node_modules/.package-json-hash"
            CURRENT_HASH=$(md5sum package.json | cut -d' ' -f1)
            CACHED_HASH=$(cat $HASH_FILE 2>/dev/null || echo "")
            
            if [ ! -d "node_modules" ] || [ "$CURRENT_HASH" != "$CACHED_HASH" ]; then
              echo "Installing admin dependencies..."
              NODE_OPTIONS="--max-old-space-size=512" npm ci --omit=dev --no-audit --no-fund --prefer-offline --legacy-peer-deps
              echo "$CURRENT_HASH" > "$HASH_FILE"
            else
              echo "Admin dependencies are up to date, skipping installation"
            fi
            
            # Create .env file from secrets
            echo "${{ secrets.ADMIN_ENV }}" > .env.local
            
            # Quick Nginx config check and reload if needed
            cd ..
            if ! cmp -s config/nginx.conf /etc/nginx/sites-available/growkapital 2>/dev/null; then
              echo "Updating Nginx configuration..."
              sudo cp config/nginx.conf /etc/nginx/sites-available/growkapital
              sudo ln -sf /etc/nginx/sites-available/growkapital /etc/nginx/sites-enabled/
              if sudo nginx -t; then
                sudo systemctl reload nginx
              else
                echo "Nginx config test failed, keeping previous config"
                exit 1
              fi
            fi
            
            # Start the applications
            cd frontend
            echo "Starting the frontend application..."
            pm2 start npm --name "growkapital-frontend" -- start
            
            cd ../admin
            echo "Starting the admin application..."
            pm2 start npm --name "growkapital-admin" -- start
            
            pm2 save --silent
            
            if [ -f "/tmp/files-changed" ]; then
              rm -f "/tmp/files-changed"
              echo "Deployment completed successfully"
            else
              echo "No changes detected, deployment completed"
            fi 
name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            admin/package-lock.json

      # Build Frontend
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          npm install --legacy-peer-deps
          npm install --save framer-motion recharts --legacy-peer-deps

      - name: Build frontend application
        working-directory: ./frontend
        run: |
          echo "Package.json date-fns version:"
          cat package.json | grep date-fns
          export NODE_OPTIONS="--max-old-space-size=4096"
          export NEXT_TELEMETRY_DISABLED=1
          export NEXT_PUBLIC_API_URL=https://api.yourdomain.com
          export NEXT_PUBLIC_SKIP_BUILD_ERROR=1
          export NEXT_BUFFER_SIZE=16384
          export GENERATE_SOURCEMAP=false
          npm run build:prod || true
        
      # Build Admin
      - name: Install admin dependencies
        working-directory: ./admin
        run: npm install --legacy-peer-deps

      - name: Build admin application
        working-directory: ./admin
        run: |
          export NODE_OPTIONS="--max-old-space-size=4096"
          export NEXT_TELEMETRY_DISABLED=1
          export NEXT_PUBLIC_SKIP_BUILD_ERROR=1
          export NEXT_BUFFER_SIZE=16384
          export GENERATE_SOURCEMAP=false
          npm run build:prod || true

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEYS }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Sync changed files
        run: |
          # Create a temporary directory for organizing files
          mkdir -p temp_deploy/frontend
          mkdir -p temp_deploy/admin
          mkdir -p temp_deploy/backend
          mkdir -p temp_deploy/config
          mkdir -p temp_deploy/scripts
          
          # Check if builds succeeded
          echo "Checking if frontend build created .next directory..."
          if [ -d "frontend/.next" ]; then
            echo "Frontend build succeeded"
            # Copy frontend files
            cp -r frontend/.next temp_deploy/frontend/
            cp -r frontend/public temp_deploy/frontend/
            cp frontend/package.json temp_deploy/frontend/
            cp frontend/package-lock.json temp_deploy/frontend/
          else
            echo "WARNING: Frontend build may have failed - .next directory not found"
            mkdir -p temp_deploy/frontend/.next
            cp -r frontend/public temp_deploy/frontend/
            cp frontend/package.json temp_deploy/frontend/
            cp frontend/package-lock.json temp_deploy/frontend/
          fi
          
          # Check if admin build succeeded
          echo "Checking if admin build created .next directory..."
          if [ -d "admin/.next" ]; then
            echo "Admin build succeeded"
            # Copy admin files
            cp -r admin/.next temp_deploy/admin/
            cp -r admin/public temp_deploy/admin/
            cp admin/package.json temp_deploy/admin/
            cp admin/package-lock.json temp_deploy/admin/
          else
            echo "WARNING: Admin build may have failed - .next directory not found"
            mkdir -p temp_deploy/admin/.next
            cp -r admin/public temp_deploy/admin/
            cp admin/package.json temp_deploy/admin/
            cp admin/package-lock.json temp_deploy/admin/
          fi
          
          # Copy backend files
          cp -r backend/src temp_deploy/backend/
          cp -r backend/prisma temp_deploy/backend/
          cp backend/package.json temp_deploy/backend/
          cp backend/package-lock.json temp_deploy/backend/
          cp backend/tsconfig.json temp_deploy/backend/
          cp backend/.env.example temp_deploy/backend/
          cp -r backend/docker-compose.prod.yml temp_deploy/backend/
          cp -r backend/Dockerfile.prod temp_deploy/backend/
          
          # Copy config and scripts
          cp config/nginx.conf temp_deploy/config/
          cp scripts/deploy.sh temp_deploy/scripts/
          
          # Create archive from the organized directory
          cd temp_deploy
          tar -czf ../deploy.tar.gz .
          cd ..
          
          # Clean up temporary directory
          rm -rf temp_deploy
          
          # Copy archive to server
          scp -i ~/.ssh/deploy_key deploy.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/
          
          # Extract and sync only changed files
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
            cd /var/www/growkapital
            mkdir -p /tmp/new-deploy
            cd /tmp/new-deploy
            tar xzf /tmp/deploy.tar.gz
            rsync -av --delete --exclude="node_modules" --exclude=".git" --exclude="node_modules_cache" . /var/www/growkapital/
            # Ensure proper permissions for Next.js static files
            chmod -R 755 /var/www/growkapital/frontend/.next/static
            chmod -R 755 /var/www/growkapital/frontend/public
            chmod -R 755 /var/www/growkapital/admin/.next/static
            chmod -R 755 /var/www/growkapital/admin/public
            
            # Verify public directories
            echo "Verifying public directories..."
            if [ -d "/var/www/growkapital/frontend/public" ]; then
              echo "✓ Frontend public directory exists"
              ls -la /var/www/growkapital/frontend/public | head -10
            else
              echo "✗ Frontend public directory is missing!"
            fi
            
            if [ -d "/var/www/growkapital/admin/public" ]; then
              echo "✓ Admin public directory exists"
              ls -la /var/www/growkapital/admin/public | head -5
            else
              echo "✗ Admin public directory is missing!"
            fi
            
            touch /tmp/files-changed
            rm -rf /tmp/new-deploy /tmp/deploy.tar.gz
          '

      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEYS }}
          command_timeout: "15m"
          script: |
            cd /var/www/growkapital
            
            # Cleanup any leftover temporary files
            rm -rf /tmp/new-deploy /tmp/deploy.tar.gz node_modules_old
            
            # Memory optimization: Clear system cache
            sync && echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null
            
            # Deploy Backend
            cd backend
            
            # Create .env file from secrets
            echo "${{ secrets.BACKEND_ENV }}" > .env
            
            # Start or restart Docker containers
            echo "Deploying backend services..."
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d --build
            
            # Verify backend is running
            echo "Verifying backend deployment..."
            sleep 10 # Give containers time to start
            if docker ps | grep -q "backend"; then
              echo "✅ Backend container is running"
            else
              echo "❌ WARNING: Backend container not found in docker ps output"
              docker ps
              docker-compose -f docker-compose.prod.yml logs
            fi
            
            # Check if port 4000 is accessible
            if netstat -tuln | grep -q ":4000 "; then
              echo "✅ Port 4000 is open and listening"
              curl -s http://localhost:4000/api/health || echo "Note: Health endpoint may not be implemented"
            else
              echo "❌ WARNING: Port 4000 is not open. Backend may not be accessible!"
              sudo netstat -tuln
            fi
            
            # Deploy Frontend
            cd ../frontend
            
            # Check if app is already running
            if pm2 list | grep -q "growkapital-frontend"; then
              echo "Frontend is running, restarting..."
              pm2 delete growkapital-frontend
            else
              echo "Frontend not running, will start fresh..."
            fi
            
            # Memory-efficient dependency management
            HASH_FILE="node_modules/.package-json-hash"
            CURRENT_HASH=$(md5sum package.json | cut -d' ' -f1)
            CACHED_HASH=$(cat $HASH_FILE 2>/dev/null || echo "")
            
            if [ ! -d "node_modules" ] || [ "$CURRENT_HASH" != "$CACHED_HASH" ]; then
              echo "Installing frontend dependencies..."
              NODE_OPTIONS="--max-old-space-size=512" npm ci --omit=dev --no-audit --no-fund --prefer-offline --legacy-peer-deps
              # Install required packages that might be missing
              npm install --save framer-motion recharts --legacy-peer-deps
              echo "$CURRENT_HASH" > "$HASH_FILE"
            else
              echo "Frontend dependencies are up to date, skipping installation"
            fi
            
            # Create .env file from secrets
            echo "${{ secrets.FRONTEND_ENV }}" > .env
            
            # Deploy Admin
            cd ../admin
            
            # Check if admin app is already running
            if pm2 list | grep -q "growkapital-admin"; then
              echo "Admin is running, restarting..."
              pm2 delete growkapital-admin
            else
              echo "Admin not running, will start fresh..."
            fi
            
            # Memory-efficient dependency management
            HASH_FILE="node_modules/.package-json-hash"
            CURRENT_HASH=$(md5sum package.json | cut -d' ' -f1)
            CACHED_HASH=$(cat $HASH_FILE 2>/dev/null || echo "")
            
            if [ ! -d "node_modules" ] || [ "$CURRENT_HASH" != "$CACHED_HASH" ]; then
              echo "Installing admin dependencies..."
              NODE_OPTIONS="--max-old-space-size=512" npm ci --omit=dev --no-audit --no-fund --prefer-offline --legacy-peer-deps
              echo "$CURRENT_HASH" > "$HASH_FILE"
            else
              echo "Admin dependencies are up to date, skipping installation"
            fi
            
            # Create .env file from secrets
            echo "${{ secrets.ADMIN_ENV }}" > .env.local
            
            # Quick Nginx config check and reload if needed
            cd ..
            if ! cmp -s config/nginx.conf /etc/nginx/sites-available/growkapital 2>/dev/null; then
              echo "Updating Nginx configuration..."
              sudo cp config/nginx.conf /etc/nginx/sites-available/growkapital
              sudo ln -sf /etc/nginx/sites-available/growkapital /etc/nginx/sites-enabled/
              if sudo nginx -t; then
                sudo systemctl reload nginx
              else
                echo "Nginx config test failed, keeping previous config"
                exit 1
              fi
            fi
            
            # Start the applications
            cd frontend
            echo "Starting the frontend application..."
            pm2 start npm --name "growkapital-frontend" -- start
            
            cd ../admin
            echo "Starting the admin application..."
            pm2 start npm --name "growkapital-admin" -- start
            
            pm2 save --silent
            
            # Verify critical pages are accessible
            echo "Verifying critical pages..."
            LOGIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://growkapital.com/login)
            echo "Login page status: $LOGIN_STATUS"
            if [ "$LOGIN_STATUS" = "200" ]; then
              echo "✓ Login page is accessible"
            else
              echo "✗ Login page returned status $LOGIN_STATUS"
              # Check Next.js server logs
              pm2 logs growkapital-frontend --lines 20 --nostream
            fi
            
            # Verify SSL certificate for both domains
            echo "Verifying SSL certificates..."
            MAIN_SSL=$(curl -sI https://growkapital.com | grep -i "HTTP/")
            ADMIN_SSL=$(curl -sI https://admin.growkapital.com | grep -i "HTTP/")
            echo "Main domain SSL: $MAIN_SSL"
            echo "Admin subdomain SSL: $ADMIN_SSL"
            
            # Check certificate expiration and domains
            echo "SSL certificate details:"
            CERT_INFO=$(echo | openssl s_client -showcerts -servername growkapital.com -connect growkapital.com:443 2>/dev/null | openssl x509 -noout -dates -subject -issuer -ext subjectAltName)
            echo "$CERT_INFO"
            
            # Check if admin subdomain is covered by certificate
            if echo "$CERT_INFO" | grep -q "admin.growkapital.com"; then
              echo "✅ admin.growkapital.com is included in the SSL certificate"
            else
              echo "⚠️ admin.growkapital.com is NOT included in the SSL certificate!"
              echo "Attempting to expand certificate to include admin subdomain..."
              
              # Only proceed with auto-expansion if explicitly allowed by environment variable
              if [ "$AUTO_EXPAND_SSL" = "true" ]; then
                echo "AUTO_EXPAND_SSL is enabled, proceeding with certificate expansion"
                sudo certbot --expand -d growkapital.com -d www.growkapital.com -d admin.growkapital.com --non-interactive
                if [ $? -eq 0 ]; then
                  echo "Certificate expansion successful!"
                  sudo systemctl reload nginx
                else
                  echo "Certificate expansion failed, please try manually:"
                  echo "sudo certbot --expand -d growkapital.com -d www.growkapital.com -d admin.growkapital.com"
                fi
              else
                echo "AUTO_EXPAND_SSL is not enabled. To automatically expand the certificate, set AUTO_EXPAND_SSL=true"
                echo "Manual command: sudo certbot --expand -d growkapital.com -d www.growkapital.com -d admin.growkapital.com"
              fi
            fi
            
            # Check if certificate renewal is needed (if less than 30 days until expiration)
            echo "Checking if certificate renewal is needed..."
            EXPIRY_DATE=$(echo | openssl s_client -showcerts -servername growkapital.com -connect growkapital.com:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
            EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
            NOW_EPOCH=$(date +%s)
            DAYS_REMAINING=$(( (EXPIRY_EPOCH - NOW_EPOCH) / 86400 ))
            echo "SSL certificate expires in $DAYS_REMAINING days"
            
            if [ "$DAYS_REMAINING" -lt 30 ]; then
              echo "Certificate expiring soon, attempting renewal..."
              sudo certbot renew --quiet
              if [ $? -eq 0 ]; then
                echo "Certificate renewal successful"
                sudo systemctl reload nginx
              else
                echo "Certificate renewal failed, please check manually"
              fi
            else
              echo "Certificate is still valid for more than 30 days"
            fi
            
            if [ -f "/tmp/files-changed" ]; then
              rm -f "/tmp/files-changed"
              echo "Deployment completed successfully"
            else
              echo "No changes detected, deployment completed"
            fi 
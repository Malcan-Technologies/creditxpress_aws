name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEYS }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Sync changed files
        run: |
          # Create archive of files to sync
          tar -czf deploy.tar.gz .next/ public/ package.json package-lock.json nginx.conf
          
          # Copy archive to server
          scp -i ~/.ssh/deploy_key deploy.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/
          
          # Extract and sync only changed files
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
            cd /var/www/growkapital
            mkdir -p /tmp/new-deploy
            cd /tmp/new-deploy
            tar xzf /tmp/deploy.tar.gz
            rsync -av --delete --exclude="node_modules" --exclude=".git" . /var/www/growkapital/
            rm -rf /tmp/new-deploy /tmp/deploy.tar.gz
          '

      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEYS }}
          command_timeout: "10m"
          script: |
            cd /var/www/growkapital
            
            # Check if app is already running
            if pm2 list | grep -q "growkapital"; then
              echo "Application is running, checking for changes..."
            else
              echo "Application not running, will start fresh..."
            fi
            
            # Efficient dependency management with better error handling
            HASH_FILE="node_modules/.package-json-hash"
            CURRENT_HASH=$(md5sum package.json | cut -d' ' -f1)
            CACHED_HASH=$(cat $HASH_FILE 2>/dev/null || echo "")
            
            if [ ! -d "node_modules" ] || [ "$CURRENT_HASH" != "$CACHED_HASH" ]; then
              echo "Installing dependencies..."
              # Backup existing modules if they exist
              if [ -d "node_modules" ]; then
                mv node_modules node_modules_old
              fi
              
              # Try to use cached modules first
              if [ -d "/var/www/node_modules_cache/growkapital" ]; then
                cp -r /var/www/node_modules_cache/growkapital node_modules
              fi
              
              # Install missing dependencies
              npm ci --omit=dev --quiet --no-audit --no-fund || {
                echo "Fresh install required..."
                rm -rf node_modules
                npm ci --omit=dev --quiet --no-audit --no-fund
              }
              
              # Update cache
              mkdir -p /var/www/node_modules_cache
              rm -rf /var/www/node_modules_cache/growkapital
              cp -r node_modules /var/www/node_modules_cache/growkapital
              echo "$CURRENT_HASH" > "$HASH_FILE"
              
              # Clean up backup
              rm -rf node_modules_old
            else
              echo "Dependencies are up to date, skipping installation"
            fi
            
            # Quick Nginx config check and reload if needed
            if ! cmp -s nginx.conf /etc/nginx/sites-available/growkapital 2>/dev/null; then
              echo "Updating Nginx configuration..."
              sudo cp nginx.conf /etc/nginx/sites-available/growkapital
              sudo ln -sf /etc/nginx/sites-available/growkapital /etc/nginx/sites-enabled/
              if sudo nginx -t; then
                sudo systemctl reload nginx
              else
                echo "Nginx config test failed, keeping previous config"
                exit 1
              fi
            fi
            
            # Efficient app restart only if needed
            if [ -f "/tmp/files-changed" ]; then
              echo "Changes detected, restarting application..."
              pm2 reload growkapital 2>/dev/null || pm2 start npm --name "growkapital" --silent -- start
              pm2 save --silent
              rm -f /tmp/files-changed
              echo "Deployment completed successfully"
            else
              echo "No changes detected, skipping restart"
            fi 
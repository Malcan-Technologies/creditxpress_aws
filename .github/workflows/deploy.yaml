name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            admin/package-lock.json

      # Build Frontend
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          npm install --legacy-peer-deps
          npm install --save framer-motion recharts --legacy-peer-deps

      - name: Build frontend application
        working-directory: ./frontend
        run: |
          # Create temporary .env file for build
          echo "${{ secrets.FRONTEND_ENV }}" > .env.build
          
          # Extract API URL from secrets for build environment
          API_URL=$(grep NEXT_PUBLIC_API_URL .env.build | cut -d '=' -f2 || echo "https://growkapital.com/api")
          
          echo "Package.json date-fns version:"
          cat package.json | grep date-fns
          echo "Using API URL: $API_URL"
          
          export NODE_OPTIONS="--max-old-space-size=4096"
          export NEXT_TELEMETRY_DISABLED=1
          export NEXT_PUBLIC_API_URL=$API_URL
          export NEXT_PUBLIC_SKIP_BUILD_ERROR=1
          export NEXT_BUFFER_SIZE=16384
          export GENERATE_SOURCEMAP=false
          
          npm run build:prod || true
          rm .env.build  # Clean up temporary file
        
      # Build Admin
      - name: Install admin dependencies
        working-directory: ./admin
        run: npm install --legacy-peer-deps

      - name: Build admin application
        working-directory: ./admin
        run: |
          # Create temporary .env file for build
          echo "${{ secrets.ADMIN_ENV }}" > .env.build
          
          # Extract API URL from secrets for build environment  
          ADMIN_API_URL=$(grep NEXT_PUBLIC_API_URL .env.build | cut -d '=' -f2 || echo "https://growkapital.com/api")
          
          echo "Using Admin API URL: $ADMIN_API_URL"
          
          export NODE_OPTIONS="--max-old-space-size=4096"
          export NEXT_TELEMETRY_DISABLED=1
          export NEXT_PUBLIC_API_URL=$ADMIN_API_URL
          export NEXT_PUBLIC_SKIP_BUILD_ERROR=1
          export NEXT_BUFFER_SIZE=16384
          export GENERATE_SOURCEMAP=false
          
          npm run build:prod || true
          rm .env.build  # Clean up temporary file

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEYS }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Prepare deployment files
        run: |
          # Add descriptive name to package.json for easier identification
          cd frontend
          sed -i 's/"name": "frontend"/"name": "growkapital-frontend"/g' package.json
          cd ..
          
          cd admin
          sed -i 's/"name": "admin"/"name": "growkapital-admin"/g' package.json
          cd ..
          
          # Create a temporary directory for organizing files
          mkdir -p temp_deploy/frontend
          mkdir -p temp_deploy/admin
          mkdir -p temp_deploy/backend
          mkdir -p temp_deploy/config
          mkdir -p temp_deploy/scripts
          
          # Check if builds succeeded
          echo "Checking if frontend build created .next directory..."
          if [ -d "frontend/.next" ]; then
            echo "Frontend build succeeded"
            # Copy frontend files
            cp -r frontend/.next temp_deploy/frontend/
            cp -r frontend/public temp_deploy/frontend/
            cp frontend/package.json temp_deploy/frontend/
            cp frontend/package-lock.json temp_deploy/frontend/
          else
            echo "WARNING: Frontend build may have failed - .next directory not found"
            mkdir -p temp_deploy/frontend/.next
            cp -r frontend/public temp_deploy/frontend/
            cp frontend/package.json temp_deploy/frontend/
            cp frontend/package-lock.json temp_deploy/frontend/
          fi
          
          # Check if admin build succeeded
          echo "Checking if admin build created .next directory..."
          if [ -d "admin/.next" ]; then
            echo "Admin build succeeded"
            # Copy admin files
            cp -r admin/.next temp_deploy/admin/
            cp -r admin/public temp_deploy/admin/
            cp admin/package.json temp_deploy/admin/
            cp admin/package-lock.json temp_deploy/admin/
          else
            echo "WARNING: Admin build may have failed - .next directory not found"
            mkdir -p temp_deploy/admin/.next
            cp -r admin/public temp_deploy/admin/
            cp admin/package.json temp_deploy/admin/
            cp admin/package-lock.json temp_deploy/admin/
          fi
          
          # Copy backend files
          cp -r backend/src temp_deploy/backend/
          cp -r backend/prisma temp_deploy/backend/
          cp backend/package.json temp_deploy/backend/
          cp backend/package-lock.json temp_deploy/backend/
          cp backend/tsconfig.json temp_deploy/backend/
          cp -r backend/docker-compose.prod.yml temp_deploy/backend/
          cp -r backend/Dockerfile.prod temp_deploy/backend/
          
          # Copy config and scripts
          cp config/nginx.conf temp_deploy/config/
          cp scripts/deploy.sh temp_deploy/scripts/
          
          # Create archive from the organized directory
          cd temp_deploy
          
          # Check if /mnt has more space
          if [ -d "/mnt" ] && [ -w "/mnt" ]; then
            TEMP_TAR_DIR="/mnt"
          else
            TEMP_TAR_DIR="/tmp"
          fi
          
          echo "Using $TEMP_TAR_DIR for temporary tar storage"
          
          # Create separate archives for each component to avoid disk space issues
          echo "Creating archives for deployment..."
          
          # Create a temporary directory for each component
          TEMP_STAGE_DIR="$TEMP_TAR_DIR/staging"
          mkdir -p "$TEMP_STAGE_DIR/frontend"
          mkdir -p "$TEMP_STAGE_DIR/admin"
          mkdir -p "$TEMP_STAGE_DIR/backend"
          mkdir -p "$TEMP_STAGE_DIR/config"
          
          # Copy files to staging with proper filtering
          echo "Preparing frontend files..."
          rsync -a --exclude="node_modules" --exclude=".git" frontend/ "$TEMP_STAGE_DIR/frontend/frontend/"
          
          echo "Preparing admin files..."
          rsync -a --exclude="node_modules" --exclude=".git" admin/ "$TEMP_STAGE_DIR/admin/admin/"
          
          echo "Preparing backend files..."
          rsync -a --exclude="node_modules" --exclude=".git" backend/ "$TEMP_STAGE_DIR/backend/backend/"
          
          echo "Preparing config and scripts files..."
          rsync -a config/ "$TEMP_STAGE_DIR/config/config/"
          rsync -a scripts/ "$TEMP_STAGE_DIR/config/scripts/"
          
          # Create tar files using consistent flags
          echo "Creating frontend archive..."
          tar -czf "$TEMP_TAR_DIR/frontend.tar.gz" -C "$TEMP_STAGE_DIR/frontend" .
          
          echo "Creating admin archive..."
          tar -czf "$TEMP_TAR_DIR/admin.tar.gz" -C "$TEMP_STAGE_DIR/admin" .
          
          echo "Creating backend archive..."
          tar -czf "$TEMP_TAR_DIR/backend.tar.gz" -C "$TEMP_STAGE_DIR/backend" .
          
          echo "Creating config archive..."
          tar -czf "$TEMP_TAR_DIR/config.tar.gz" -C "$TEMP_STAGE_DIR/config" .
          
          # Cleanup staging directory
          rm -rf "$TEMP_STAGE_DIR"
          
          cd ..
          # Clean up temporary directory
          rm -rf temp_deploy
          
          # Copy archives to server
          scp -i ~/.ssh/deploy_key $TEMP_TAR_DIR/frontend.tar.gz $TEMP_TAR_DIR/admin.tar.gz $TEMP_TAR_DIR/backend.tar.gz $TEMP_TAR_DIR/config.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/
          
          # Extract files on server in chunks to avoid disk space issues
          ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
            # Set up extraction paths with proper cleanup first
            echo "Setting up extraction directories..."
            rm -rf /tmp/new-deploy-frontend /tmp/new-deploy-admin /tmp/new-deploy-backend /tmp/new-deploy-config
            mkdir -p /tmp/new-deploy-frontend /tmp/new-deploy-admin /tmp/new-deploy-backend /tmp/new-deploy-config
            
            echo "Extracting frontend files..."
            tar -xzf /tmp/frontend.tar.gz -C /tmp/new-deploy-frontend || { echo "Frontend extraction failed"; exit 1; }
            
            echo "Extracting admin files..."
            tar -xzf /tmp/admin.tar.gz -C /tmp/new-deploy-admin || { echo "Admin extraction failed"; exit 1; }
            
            echo "Extracting backend files..."
            tar -xzf /tmp/backend.tar.gz -C /tmp/new-deploy-backend || { echo "Backend extraction failed"; exit 1; }
            
            echo "Extracting config files..."
            tar -xzf /tmp/config.tar.gz -C /tmp/new-deploy-config || { echo "Config extraction failed"; exit 1; }
            
            # Create backup of critical configuration files
            echo "Creating backup of critical files..."
            BACKUP_DIR="/var/www/growkapital/config_backup_$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            
            # Backup critical files before syncing
            if [ -f "/var/www/growkapital/frontend/.env" ]; then
              cp /var/www/growkapital/frontend/.env "$BACKUP_DIR/frontend.env"
            fi
            if [ -f "/var/www/growkapital/admin/.env.local" ]; then
              cp /var/www/growkapital/admin/.env.local "$BACKUP_DIR/admin.env.local"
            fi
            if [ -f "/var/www/growkapital/backend/.env" ]; then
              cp /var/www/growkapital/backend/.env "$BACKUP_DIR/backend.env"
            fi
            
            # Create destination directories if they don't exist
            echo "Creating destination directories..."
            mkdir -p /var/www/growkapital/frontend
            mkdir -p /var/www/growkapital/admin
            mkdir -p /var/www/growkapital/backend
            mkdir -p /var/www/growkapital/config
            mkdir -p /var/www/growkapital/scripts
            
            # Sync using rsync with proper flags for preserving permissions
            echo "Syncing frontend files..."
            rsync -av --delete /tmp/new-deploy-frontend/frontend/ /var/www/growkapital/frontend/
            
            echo "Syncing admin files..."
            rsync -av --delete /tmp/new-deploy-admin/admin/ /var/www/growkapital/admin/
            
            echo "Syncing backend files..."
            rsync -av --delete /tmp/new-deploy-backend/backend/ /var/www/growkapital/backend/
            
            # Config and scripts
            echo "Syncing config and scripts..."
            rsync -av --delete /tmp/new-deploy-config/config/ /var/www/growkapital/config/
            rsync -av --delete /tmp/new-deploy-config/scripts/ /var/www/growkapital/scripts/
            
            # Verify critical directories exist
            echo "Verifying critical directories..."
            if [ ! -d "/var/www/growkapital/frontend/.next" ]; then
              echo "⚠️ Frontend .next directory not found. Rebuilding..."
              cd /var/www/growkapital/frontend
              npm install --production
              npm run build
              cd -
            else
              echo "✓ Frontend .next directory exists"
            fi
            
            if [ ! -d "/var/www/growkapital/frontend/public" ]; then
              echo "⚠️ Frontend public directory not found. Creating..."
              mkdir -p /var/www/growkapital/frontend/public
            else
              echo "✓ Frontend public directory exists"
            fi
            
            if [ ! -d "/var/www/growkapital/admin/.next" ]; then
              echo "⚠️ Admin .next directory not found. Rebuilding..."
              cd /var/www/growkapital/admin
              npm install --production
              npm run build
              cd -
            else
              echo "✓ Admin .next directory exists"
            fi
            
            if [ ! -d "/var/www/growkapital/admin/public" ]; then
              echo "⚠️ Admin public directory not found. Creating..."
              mkdir -p /var/www/growkapital/admin/public
            else
              echo "✓ Admin public directory exists"
            fi
            
            # Ensure proper permissions for all directories
            echo "Setting permissions..."
            chown -R $USER:$USER /var/www/growkapital
            find /var/www/growkapital -type d -exec chmod 755 {} \;
            find /var/www/growkapital -type f -exec chmod 644 {} \;
            chmod +x /var/www/growkapital/scripts/*.sh
            
            # Verify and fix ownership if needed
            echo "Current ownership of /var/www/growkapital is $(stat -c "%U:%G" /var/www/growkapital)"
            
            # Verify public directories
            echo "Verifying public directories..."
            if [ -d "/var/www/growkapital/frontend/public" ]; then
              echo "✓ Frontend public directory exists"
            else
              echo "✗ Frontend public directory is missing!"
            fi
            
            if [ -d "/var/www/growkapital/admin/public" ]; then
              echo "✓ Admin public directory exists"
            else
              echo "✗ Admin public directory is missing!"
            fi
            
            # Restart services
            echo "Restarting services..."
            if systemctl is-active --quiet nginx; then
              systemctl reload nginx
              echo "✓ Nginx reloaded"
            else
              systemctl start nginx
              echo "✓ Nginx started"
            fi
            
            cd /var/www/growkapital/backend
            
            # If PM2 is running, restart the backend service
            if which pm2 > /dev/null && pm2 list | grep -q "backend"; then
              pm2 restart backend || pm2 start npm --name "backend" -- start
              echo "✓ Backend service restarted"
            else
              # If PM2 is not running or backend not found, start it
              pm2 start npm --name "backend" -- start
              echo "✓ Backend service started"
            fi
            
            touch /tmp/files-changed
            rm -rf /tmp/new-deploy-frontend /tmp/new-deploy-admin /tmp/new-deploy-backend /tmp/new-deploy-config /tmp/frontend.tar.gz /tmp/admin.tar.gz /tmp/backend.tar.gz /tmp/config.tar.gz
          '

      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEYS }}
          command_timeout: "15m"
          script: |
            # Verify target directory integrity before deploying
            echo "Verifying deployment target directory..."
            if [ ! -d "/var/www/growkapital" ]; then
              echo "ERROR: Target directory /var/www/growkapital does not exist!"
              echo "Creating directory structure..."
              sudo mkdir -p /var/www/growkapital
              sudo chown -R $USER:$USER /var/www/growkapital
            fi
            
            # Check disk space
            echo "Checking disk space..."
            df -h
            
            # Clean up disk space if needed
            FREE_SPACE_KB=$(df -k / | awk 'NR==2 {print $4}')
            echo "Free space: ${FREE_SPACE_KB}KB"
            
            if [ ${FREE_SPACE_KB} -lt 1048576 ]; then  # Less than 1GB free
              echo "Low disk space detected, cleaning up..."
              
              # Clean Docker
              echo "Cleaning Docker resources..."
              docker system prune -af --volumes || true
              
              # Clean npm caches
              echo "Cleaning npm caches..."
              npm cache clean --force || true
              
              # Clean temporary files
              echo "Cleaning temporary files..."
              sudo rm -rf /tmp/* || true
              
              # Clean old logs
              echo "Cleaning old logs..."
              sudo find /var/log -type f -name "*.gz" -delete || true
              sudo find /var/log -type f -name "*.1" -delete || true
              sudo find /var/log -type f -name "*.old" -delete || true
              
              # Clean old deployments
              echo "Cleaning old deployment backups..."
              find /var/www/growkapital -name "config_backup_*" -type d -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
              
              # Check space after cleanup
              echo "Space after cleanup:"
              df -h
            fi
            
            # Install debugging tools if needed
            if ! command -v wkhtmltoimage > /dev/null; then
              echo "Installing wkhtmltopdf for debugging screenshots..."
              sudo apt-get update
              sudo apt-get install -y wkhtmltopdf
            fi
            
            # Check for potential conflicts with other websites
            echo "Checking for potential website conflicts..."
            ls -la /var/www/
            
            # Verify this is the correct project by checking for unique identifiers
            if [ -f "/var/www/growkapital/frontend/package.json" ]; then
              echo "Verifying project identity..."
              if grep -q "\"name\":" /var/www/growkapital/frontend/package.json; then
                PROJECT_NAME=$(grep "\"name\":" /var/www/growkapital/frontend/package.json | cut -d '"' -f 4)
                echo "Found project name: $PROJECT_NAME"
                
                # Accept either "growkapital", "growkapital-frontend", or just "frontend"
                if [[ "$PROJECT_NAME" == "growkapital"* || "$PROJECT_NAME" == "frontend" ]]; then
                  echo "✓ Confirmed target directory contains the correct project"
                else
                  echo "WARNING: Target directory may contain a different project!"
                  echo "Project verification failed. Please check manually."
                  grep "name" /var/www/growkapital/frontend/package.json
                  exit 1
                fi
              else
                echo "WARNING: Couldn't determine project name from package.json!"
                cat /var/www/growkapital/frontend/package.json | head -5
                exit 1
              fi
            fi
            
            cd /var/www/growkapital
            
            # Cleanup any leftover temporary files
            rm -rf /tmp/new-deploy-frontend /tmp/new-deploy-admin /tmp/new-deploy-backend /tmp/new-deploy-config
            
            # Memory optimization: Clear system cache
            sync && echo 3 | sudo tee /proc/sys/vm/drop_caches >/dev/null
            
            # Deploy Backend
            cd backend
            
            # Create .env file from secrets
            echo "${{ secrets.BACKEND_ENV }}" > .env
            
            # Verify critical backend environment variables
            echo "Checking backend environment configuration..."
            # Note: We're only checking existence, not displaying sensitive values
            if grep -q "PORT" .env && grep -q "DATABASE_URL" .env && grep -q "JWT_SECRET" .env; then
              echo "✓ Backend environment includes required variables"
              BACKEND_PORT=$(grep "PORT" .env | cut -d '=' -f2 || echo "4000")
              echo "Backend configured to use port: $BACKEND_PORT"
            else
              echo "⚠️ WARNING: Backend environment missing critical variables!"
              grep -v "PASSWORD\|SECRET" .env | grep "=" || echo "No readable variables found"
            fi
            
            # Start or restart Docker containers
            echo "Deploying backend services..."
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d --build
            
            # Verify backend is running
            echo "Verifying backend deployment..."
            sleep 10 # Give containers time to start
            if docker ps | grep -q "backend"; then
              echo "✅ Backend container is running"
            else
              echo "❌ WARNING: Backend container not found in docker ps output"
              docker ps
              docker-compose -f docker-compose.prod.yml logs
            fi
            
            # Check if backend port is accessible
            if netstat -tuln | grep -q ":$BACKEND_PORT "; then
              echo "✅ Port $BACKEND_PORT is open and listening"
              curl -s http://localhost:$BACKEND_PORT/api/health || echo "Note: Health endpoint may not be implemented"
            else
              echo "❌ WARNING: Port $BACKEND_PORT is not open. Backend may not be accessible!"
              sudo netstat -tuln
            fi
            
            # Deploy Frontend
            cd ../frontend
            
            # Quick Nginx config check and reload if needed
            cd ..
            if ! cmp -s config/nginx.conf /etc/nginx/sites-available/growkapital 2>/dev/null; then
              echo "Updating Nginx configuration..."
              sudo cp config/nginx.conf /etc/nginx/sites-available/growkapital
              sudo ln -sf /etc/nginx/sites-available/growkapital /etc/nginx/sites-enabled/
              if sudo nginx -t; then
                sudo systemctl reload nginx
              else
                echo "Nginx config test failed, keeping previous config"
                exit 1
              fi
            fi
            
            # Verify nginx configuration is pointing to the correct directories
            echo "Verifying nginx configuration paths..."
            NGINX_CONFIG=$(sudo cat /etc/nginx/sites-available/growkapital)
            
            if echo "$NGINX_CONFIG" | grep -q "/var/www/growkapital/frontend"; then
              echo "✓ Nginx config correctly references /var/www/growkapital/frontend"
            else
              echo "✗ WARNING: Nginx config does not reference /var/www/growkapital/frontend!"
              echo "This might be causing the layout issues - check for incorrect paths"
            fi
            
            if echo "$NGINX_CONFIG" | grep -q "/var/www/growkapital/admin"; then
              echo "✓ Nginx config correctly references /var/www/growkapital/admin"
            else
              echo "✗ WARNING: Nginx config does not reference /var/www/growkapital/admin!"
            fi
            
            # Check if nginx is using the correct ports
            if echo "$NGINX_CONFIG" | grep -q "proxy_pass http://localhost:3002"; then
              echo "✓ Nginx config correctly uses port 3002 for frontend"
            else
              echo "✗ WARNING: Nginx config is not using port 3002 for frontend!"
              echo "Current frontend proxy_pass:"
              echo "$NGINX_CONFIG" | grep -A1 "# Proxy settings for main application" | grep "proxy_pass"
            fi
            
            if echo "$NGINX_CONFIG" | grep -q "proxy_pass http://localhost:3003"; then
              echo "✓ Nginx config correctly uses port 3003 for admin"
            else
              echo "✗ WARNING: Nginx config is not using port 3003 for admin!"
              echo "Current admin proxy_pass:"
              echo "$NGINX_CONFIG" | grep -A1 "# Proxy settings for admin application" | grep "proxy_pass"
            fi
            
            # Check if nginx is properly configured for backend API
            if [ ! -z "$BACKEND_PORT" ]; then
              if echo "$NGINX_CONFIG" | grep -q "proxy_pass http://localhost:$BACKEND_PORT"; then
                echo "✓ Nginx config correctly uses port $BACKEND_PORT for backend API"
              else
                echo "⚠️ WARNING: Nginx configuration may not match backend port!"
                echo "Backend is configured for port $BACKEND_PORT"
                echo "Current nginx backend proxy_pass:"
                echo "$NGINX_CONFIG" | grep -A1 "# Backend API proxy" | grep "proxy_pass"
              fi
            fi
            
            # Check for potential conflicts with terraworld
            if sudo test -f /etc/nginx/sites-available/terraworld; then
              TERRAWORLD_CONFIG=$(sudo cat /etc/nginx/sites-available/terraworld)
              if echo "$TERRAWORLD_CONFIG" | grep -q "proxy_pass http://localhost:3001"; then
                echo "⚠️ terraworld.my is using port 3001 as expected"
              else
                echo "⚠️ terraworld.my is using an unexpected port, check for conflicts"
                echo "$TERRAWORLD_CONFIG" | grep -A1 "# Proxy settings for main application" | grep "proxy_pass"
              fi
            fi
            
            # List all enabled sites to check for conflicts
            echo "Enabled Nginx sites:"
            ls -la /etc/nginx/sites-enabled/
            
            # Check for port conflicts with other websites
            echo "Checking for port conflicts..."
            USED_PORTS=$(netstat -tlnp | grep -E ':(3000|3001|3002|3003)')
            echo "Currently used ports:"
            echo "$USED_PORTS"
            
            # Start the applications with specific ports that won't conflict
            echo "Starting the frontend application..."
            # Use port 3002 for frontend to avoid conflict with terraworld
            export PORT=3002
            pm2 delete growkapital-frontend 2>/dev/null || true
            pm2 start npm --name "growkapital-frontend" -- start -- -p 3002
            
            echo "Starting the admin application..."
            # Use port 3003 for admin to avoid conflict
            export PORT=3003
            pm2 delete growkapital-admin 2>/dev/null || true
            pm2 start npm --name "growkapital-admin" -- start -- -p 3003
            
            pm2 save --silent
            
            # Verify critical pages are accessible
            echo "Verifying critical pages..."
            
            # Check domain access (via nginx)
            LOGIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://growkapital.com/login)
            echo "Login page via domain status: $LOGIN_STATUS"
            if [ "$LOGIN_STATUS" = "200" ]; then
              echo "✓ Login page is accessible via domain"
            else
              echo "✗ Login page returned status $LOGIN_STATUS via domain"
            fi
            
            # Check direct port access
            DIRECT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3002/login)
            echo "Login page via direct port status: $DIRECT_STATUS"
            if [ "$DIRECT_STATUS" = "200" ]; then
              echo "✓ Login page is accessible via direct port"
            else
              echo "✗ Login page returned status $DIRECT_STATUS via direct port"
              # Check Next.js server logs
              pm2 logs growkapital-frontend --lines 20 --nostream
            fi
            
            # Check CSS and layout files
            echo "Checking for CSS and layout files..."
            if [ -d "/var/www/growkapital/frontend/.next/static/css" ]; then
              echo "✓ CSS files exist in build"
              ls -la /var/www/growkapital/frontend/.next/static/css/ | head -5
            else
              echo "✗ No CSS files found in build directory!"
            fi
            
            # Take a screenshot for layout debugging (if wkhtmltoimage is installed)
            if command -v wkhtmltoimage > /dev/null; then
              echo "Taking screenshot of homepage for layout debugging..."
              wkhtmltoimage --javascript-delay 3000 https://growkapital.com /tmp/homepage_screenshot.jpg || true
              echo "Screenshot saved to /tmp/homepage_screenshot.jpg on the server"
            else
              echo "wkhtmltoimage not installed, skipping screenshot"
            fi
            
            # Inspect page source for problematic styles
            echo "Inspecting page source for style links..."
            curl -s https://growkapital.com | grep -i "<link.*rel=\"stylesheet\"" || echo "No style links found in page source"
            
            # SSL certificate check and renewal
            echo "Checking SSL certificates..."
            if [ ! -d "/etc/letsencrypt/live/growkapital.com" ]; then
              echo "⚠️ SSL certificate directory not found! Running certbot to get new certificate..."
              sudo certbot --nginx -d growkapital.com -d www.growkapital.com -d admin.growkapital.com --agree-tos --non-interactive --email ${{ secrets.SSL_EMAIL }} || {
                echo "❌ Failed to obtain SSL certificates automatically"
                echo "Manual command: sudo certbot --nginx -d growkapital.com -d www.growkapital.com -d admin.growkapital.com"
              }
            else
              echo "✓ SSL certificate directory exists"
              
              # Check certificate expiration and domains
              echo "SSL certificate details:"
              CERT_INFO=$(echo | openssl s_client -showcerts -servername growkapital.com -connect growkapital.com:443 2>/dev/null | openssl x509 -noout -dates -subject -issuer -ext subjectAltName)
              
              if [ -z "$CERT_INFO" ]; then
                echo "⚠️ Unable to retrieve certificate info. Certificate may be missing or invalid."
                echo "Attempting to renew/obtain certificates..."
                sudo certbot --nginx -d growkapital.com -d www.growkapital.com -d admin.growkapital.com --agree-tos --non-interactive --expand --email ${{ secrets.SSL_EMAIL }} || {
                  echo "❌ Failed to renew/obtain SSL certificates automatically"
                }
              else
                echo "$CERT_INFO"
                
                # Check if admin subdomain is covered by certificate
                if echo "$CERT_INFO" | grep -q "admin.growkapital.com"; then
                  echo "✅ admin.growkapital.com is included in the SSL certificate"
                else
                  echo "⚠️ admin.growkapital.com is NOT included in the SSL certificate!"
                  echo "Expanding certificate to include admin subdomain..."
                  sudo certbot --nginx --expand -d growkapital.com -d www.growkapital.com -d admin.growkapital.com --agree-tos --non-interactive --email ${{ secrets.SSL_EMAIL }} || {
                    echo "❌ Certificate expansion failed"
                  }
                fi
              fi
              
              # Force renewal if there are issues
              if ! curl -sI https://growkapital.com | grep -q "HTTP/.*200"; then
                echo "⚠️ HTTPS check failed. Forcing certificate renewal..."
                sudo certbot renew --force-renewal --nginx
                sudo systemctl reload nginx
              fi
              
              # Debug Nginx SSL configuration
              echo "Checking Nginx SSL configuration..."
              if sudo grep -q "ssl_certificate" /etc/nginx/sites-available/growkapital; then
                echo "✓ SSL certificate paths found in Nginx config"
                sudo grep "ssl_certificate" /etc/nginx/sites-available/growkapital
              else
                echo "✗ No SSL certificate paths found in Nginx config!"
                echo "Adding SSL configuration manually..."
                
                # Backup current config
                sudo cp /etc/nginx/sites-available/growkapital /etc/nginx/sites-available/growkapital.bak
                
                # Add SSL configuration if missing
                sudo sed -i '/server_name growkapital.com www.growkapital.com;/a \
                \    ssl_certificate /etc/letsencrypt/live/growkapital.com/fullchain.pem;\
                \    ssl_certificate_key /etc/letsencrypt/live/growkapital.com/privkey.pem;\
                \    ssl_trusted_certificate /etc/letsencrypt/live/growkapital.com/chain.pem;' /etc/nginx/sites-available/growkapital
                
                # Check if edit was successful
                if sudo grep -q "ssl_certificate" /etc/nginx/sites-available/growkapital; then
                  echo "✓ Successfully added SSL certificate paths to Nginx config"
                  sudo nginx -t && sudo systemctl reload nginx
                else
                  echo "✗ Failed to add SSL certificate paths to Nginx config"
                  echo "Restoring backup..."
                  sudo cp /etc/nginx/sites-available/growkapital.bak /etc/nginx/sites-available/growkapital
                fi
              fi
              
              # Verify Nginx SSL listening
              if sudo grep -q "listen 443 ssl" /etc/nginx/sites-available/growkapital; then
                echo "✓ Nginx is configured to listen on SSL port 443"
              else
                echo "✗ Nginx is not configured to listen on SSL port 443!"
                sudo grep "listen" /etc/nginx/sites-available/growkapital
              fi
            fi
            
            if [ -f "/tmp/files-changed" ]; then
              rm -f "/tmp/files-changed"
              echo "Deployment completed successfully"
            else
              echo "No changes detected, deployment completed"
            fi 
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id                   String            @id @default(cuid())
  code                 String            @unique
  name                 String
  description          String
  minAmount            Float
  maxAmount            Float
  repaymentTerms       Json
  interestRate         Float
  eligibility          Json[]
  originationFee       Float
  legalFee             Float
  applicationFee       Float
  requiredDocuments    Json[]
  features             Json[]
  isActive             Boolean           @default(true)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  loanTypes            Json[]
  lateFeeFixedAmount   Float             @default(0)
  lateFeeFrequencyDays Int               @default(7)
  lateFeeRate          Float             @default(8.0)
  collateralRequired   Boolean           @default(false)
  applications         LoanApplication[]

  @@map("products")
}

model User {
  id                           String              @id @default(cuid())
  phoneNumber                  String              @unique
  password                     String
  refreshToken                 String?
  fullName                     String?
  dateOfBirth                  DateTime?
  email                        String?             @unique
  address1                     String?
  address2                     String?
  city                         String?
  state                        String?
  createdAt                    DateTime            @default(now())
  updatedAt                    DateTime            @updatedAt
  country                      String?
  idExpiry                     DateTime?
  idNumber                     String?
  idType                       String?
  nationality                  String?
  role                         String              @default("USER")
  zipCode                      String?
  lastLoginAt                  DateTime?           @updatedAt
  accountNumber                String?
  bankName                     String?
  employerName                 String?
  employmentStatus             String?
  monthlyIncome                String?
  serviceLength                String?
  isOnboardingComplete         Boolean             @default(false)
  kycStatus                    Boolean             @default(false)
  onboardingStep               Int                 @default(0)
  emergencyContactName         String?
  emergencyContactPhone        String?
  emergencyContactRelationship String?
  icNumber                     String?
  icType                       String?
  educationLevel               String?
  phoneVerified                Boolean             @default(false)
  resetToken                   String?
  resetTokenExpiry             DateTime?
  applications                 LoanApplication[]
  loans                        Loan[]
  notifications                Notification[]
  documents                    UserDocument[]
  walletTransactions           WalletTransaction[]
  wallet                       Wallet?
  phoneVerifications           PhoneVerification[]
  phoneChangeRequests          PhoneChangeRequest[]

  @@map("users")
}

model Wallet {
  id                     String              @id @default(cuid())
  userId                 String              @unique
  balance                Float               @default(0)
  availableForWithdrawal Float               @default(0)
  totalDeposits          Float               @default(0)
  totalWithdrawals       Float               @default(0)
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  transactions           WalletTransaction[]
  user                   User                @relation(fields: [userId], references: [id])

  @@map("wallets")
}

model WalletTransaction {
  id          String                  @id @default(cuid())
  userId      String
  walletId    String
  loanId      String?
  type        String
  amount      Float
  description String
  reference   String?
  metadata    Json?
  processedAt DateTime?
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  status      WalletTransactionStatus @default(PENDING)
  loan        Loan?                   @relation(fields: [loanId], references: [id])
  user        User                    @relation(fields: [userId], references: [id])
  wallet      Wallet                  @relation(fields: [walletId], references: [id])

  @@map("wallet_transactions")
}

model Loan {
  id                 String              @id @default(cuid())
  userId             String
  applicationId      String              @unique
  principalAmount    Float
  outstandingBalance Float
  interestRate       Float
  term               Int
  monthlyPayment     Float
  nextPaymentDue     DateTime?
  status             String              @default("ACTIVE")
  disbursedAt        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  dischargedAt       DateTime?
  totalAmount        Float
  calculationMethod  String?             // RULE_OF_78 or STRAIGHT_LINE
  scheduleType       String?             // EXACT_MONTHLY or CUSTOM_DATE  
  customDueDate      Int?                // For CUSTOM_DATE schedule type
  prorationCutoffDate Int?               // For CUSTOM_DATE proration
  lateFee            LateFee?
  repayments         LoanRepayment[]
  application        LoanApplication     @relation(fields: [applicationId], references: [id])
  user               User                @relation(fields: [userId], references: [id])
  walletTransactions WalletTransaction[]

  @@map("loans")
}

model LoanRepayment {
  id                String          @id @default(cuid())
  loanId            String
  amount            Float
  principalAmount   Float
  interestAmount    Float
  status            String          @default("PENDING")
  dueDate           DateTime
  paidAt            DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  actualAmount      Float?
  daysEarly         Int?            @default(0)
  daysLate          Int?            @default(0)
  installmentNumber Int?
  parentRepaymentId String?
  paymentType       String?
  scheduledAmount   Float?
  lateFeeAmount     Float           @default(0)
  lateFeesPaid      Float           @default(0)
  principalPaid     Float           @default(0)
  loan              Loan            @relation(fields: [loanId], references: [id])
  parentRepayment   LoanRepayment?  @relation("PartialPayments", fields: [parentRepaymentId], references: [id])
  partialPayments   LoanRepayment[] @relation("PartialPayments")

  @@index([installmentNumber])
  @@index([paymentType])
  @@index([status, dueDate])
  @@index([loanId, dueDate])
  @@map("loan_repayments")
}

model LoanApplication {
  id                       String                   @id @default(cuid())
  userId                   String
  productId                String
  amount                   Float?
  term                     Int?
  status                   String                   @default("INCOMPLETE")
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  acceptTerms              Boolean                  @default(false)
  appStep                  Int                      @default(0)
  applicationFee           Float?
  interestRate             Float?
  lateFee                  Float?
  legalFee                 Float?
  monthlyRepayment         Float?
  netDisbursement          Float?
  originationFee           Float?
  paidAppFee               Boolean                  @default(false)
  purpose                  String?
  urlLink                  String?                  @unique
  attestationCompleted     Boolean                  @default(false)
  attestationDate          DateTime?
  attestationNotes         String?
  attestationTermsAccepted Boolean                  @default(false)
  attestationType          String?
  attestationVideoWatched  Boolean                  @default(false)
  meetingCompletedAt       DateTime?
  meetingScheduledAt       DateTime?
  // Fresh offer fields
  freshOfferAmount         Float?
  freshOfferTerm           Int?
  freshOfferInterestRate   Float?
  freshOfferMonthlyRepayment Float?
  freshOfferNetDisbursement Float?
  freshOfferNotes          String?
  freshOfferSubmittedAt    DateTime?
  freshOfferSubmittedBy    String?
  // Original offer backup fields
  originalOfferAmount      Float?
  originalOfferTerm        Int?
  originalOfferInterestRate Float?
  originalOfferMonthlyRepayment Float?
  originalOfferNetDisbursement Float?
  history                  LoanApplicationHistory[]
  product                  Product                  @relation(fields: [productId], references: [id])
  user                     User                     @relation(fields: [userId], references: [id])
  disbursement             LoanDisbursement?
  loan                     Loan?
  documents                UserDocument[]

  @@map("loan_applications")
}

model LoanDisbursement {
  id                String          @id @default(cuid())
  applicationId     String          @unique
  referenceNumber   String
  amount            Float
  bankName          String?
  bankAccountNumber String?
  disbursedAt       DateTime        @default(now())
  disbursedBy       String
  notes             String?
  status            String          @default("COMPLETED")
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  application       LoanApplication @relation(fields: [applicationId], references: [id])

  @@map("loan_disbursements")
}

model UserDocument {
  id            String           @id @default(cuid())
  userId        String
  applicationId String?
  type          String
  status        String           @default("PENDING")
  fileUrl       String
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  application   LoanApplication? @relation(fields: [applicationId], references: [id])
  user          User             @relation(fields: [userId], references: [id])

  @@map("user_documents")
}

model NotificationTemplate {
  id           String           @id @default(cuid())
  code         String           @unique
  title        String
  message      String
  type         NotificationType
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  Notification Notification[]

  @@map("notification_templates")
}

model Notification {
  id         String                @id @default(cuid())
  userId     String
  title      String
  message    String
  isRead     Boolean               @default(false)
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  expiresAt  DateTime?
  metadata   Json?
  priority   NotificationPriority  @default(LOW)
  templateId String?
  type       NotificationType
  link       String?
  template   NotificationTemplate? @relation(fields: [templateId], references: [id])
  user       User                  @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model NotificationGroup {
  id          String   @id @default(cuid())
  name        String
  description String?
  filters     Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("notification_groups")
}

model LoanApplicationHistory {
  id             String          @id @default(cuid())
  applicationId  String
  previousStatus String?
  newStatus      String
  changedBy      String
  changeReason   String?
  notes          String?
  metadata       Json?
  createdAt      DateTime        @default(now())
  application    LoanApplication @relation(fields: [applicationId], references: [id])

  @@map("loan_application_history")
}

model LateFee {
  id                  String   @id @default(cuid())
  status              String   @default("ACTIVE")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  calculationDetails  Json?
  lastCalculationDate DateTime @default(now())
  loanId              String   @unique
  totalAccruedFees    Float    @default(0)
  loan                Loan     @relation(fields: [loanId], references: [id])

  @@index([lastCalculationDate])
  @@index([status])
  @@map("late_fees")
}

model LateFeeProcessingLog {
  id                 String   @id @default(cuid())
  processedAt        DateTime @default(now())
  feesCalculated     Int      @default(0)
  totalFeeAmount     Float    @default(0)
  overdue_repayments Int      @default(0)
  status             String
  errorMessage       String?
  processingTimeMs   Int?
  metadata           Json?
  createdAt          DateTime @default(now())

  @@index([processedAt])
  @@map("late_fee_processing_logs")
}

model PhoneVerification {
  id          String   @id @default(cuid())
  userId      String
  phoneNumber String
  otp         String
  expiresAt   DateTime
  verified    Boolean  @default(false)
  attempts    Int      @default(0)
  otpType     String   @default("PHONE_VERIFICATION") // OTP type for different purposes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phoneNumber])
  @@index([expiresAt])
  @@index([userId, verified])
  @@index([phoneNumber, otpType])
  @@map("phone_verifications")
}

model PhoneChangeRequest {
  id              String   @id @default(cuid())
  userId          String
  currentPhone    String
  newPhone        String
  currentVerified Boolean  @default(false)
  newVerified     Boolean  @default(false)
  changeToken     String   @unique
  expiresAt       DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([changeToken])
  @@index([expiresAt])
  @@map("phone_change_requests")
}

enum WalletTransactionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  SYSTEM
  MARKETING
  FRESH_OFFER
  FRESH_OFFER_RESPONSE
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
}

enum LoanCalculationMethod {
  PROPORTIONAL  // Use actual average days per period (current method)
  RULE_OF_78    // Use Rule of 78 calculation
  FIXED_30_DAY  // Use fixed 30-day assumption (legacy)
}

enum PaymentScheduleType {
  FIRST_OF_MONTH     // Current: 1st of month with 20th cutoff
  EXACT_MONTHLY      // Legacy: Exact monthly intervals from disbursement
  CUSTOM_DAY         // Future: Custom day of month
}

model SystemSettings {
  id                    String                @id @default(cuid())
  key                   String                @unique
  category              String                // e.g., "LOAN_CALCULATION", "PAYMENT_SCHEDULE", "GENERAL"
  name                  String                // Human-readable name
  description           String                // Description of what this setting does
  dataType              String                // "ENUM", "BOOLEAN", "STRING", "NUMBER"
  value                 String                // JSON-serialized value
  options               Json?                 // Available options for enum types
  isActive              Boolean               @default(true)
  requiresRestart       Boolean               @default(false)  // If changing requires system restart
  affectsExistingLoans  Boolean               @default(false)  // If this affects existing loans
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  lastChangedBy         String?               // Admin user who last changed this
  lastChangedAt         DateTime?             // When it was last changed

  @@map("system_settings")
}

model BankAccount {
  id            String   @id @default(cuid())
  bankName      String   // e.g., "HSBC Bank Malaysia Berhad"
  accountName   String   // e.g., "OPG Capital Holdings Sdn. Bhd."
  accountNumber String   // e.g., "001866001878013"
  isActive      Boolean  @default(true)
  isDefault     Boolean  @default(false) // For primary bank account
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?  // Admin user who created this
  
  @@map("bank_accounts")
}

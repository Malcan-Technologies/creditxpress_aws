generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum LegalFeeType {
  PERCENTAGE
  FIXED
}

model Product {
  id                   String            @id @default(cuid())
  code                 String            @unique
  name                 String
  description          String
  minAmount            Float
  maxAmount            Float
  repaymentTerms       Json
  interestRate         Float
  eligibility          Json[]
  originationFee       Float
  legalFee             Float
  applicationFee       Float
  requiredDocuments    Json[]
  features             Json[]
  isActive             Boolean           @default(true)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  loanTypes            Json[]
  lateFeeFixedAmount   Float             @default(0)
  lateFeeFrequencyDays Int               @default(7)
  lateFeeRate          Float             @default(8.0)
  collateralRequired   Boolean           @default(false)
  stampingFee          Float             @default(0)
  legalFeeFixed        Float             @default(0)
  legalFeeType         LegalFeeType      @default(FIXED)
  legalFeeValue        Float             @default(0)
  applications         LoanApplication[]

  @@map("products")
}

model User {
  id                           String               @id @default(cuid())
  phoneNumber                  String               @unique
  password                     String
  refreshToken                 String?
  fullName                     String?
  dateOfBirth                  DateTime?
  email                        String?              @unique
  address1                     String?
  address2                     String?
  city                         String?
  state                        String?
  createdAt                    DateTime             @default(now())
  updatedAt                    DateTime             @updatedAt
  country                      String?
  idExpiry                     DateTime?
  idNumber                     String?
  idType                       String?
  nationality                  String?
  role                         String               @default("USER")
  zipCode                      String?
  lastLoginAt                  DateTime?            @updatedAt
  accountNumber                String?
  bankName                     String?
  employerName                 String?
  employmentStatus             String?
  monthlyIncome                String?
  isOnboardingComplete         Boolean              @default(false)
  kycStatus                    Boolean              @default(false)
  onboardingStep               Int                  @default(0)
  icNumber                     String?
  icType                       String?
  emergencyContactName         String?
  emergencyContactPhone        String?
  emergencyContactRelationship String?
  serviceLength                String?
  phoneVerified                Boolean              @default(false)
  educationLevel               String?
  race                         String?
  gender                       String?
  occupation                   String?
  resetToken                   String?
  resetTokenExpiry             DateTime?
  kycSessions                  KycSession[]
  applications                 LoanApplication[]
  loans                        Loan[]
  notifications                Notification[]
  phoneChangeRequests          PhoneChangeRequest[]
  phoneVerifications           PhoneVerification[]
  documents                    UserDocument[]
  walletTransactions           WalletTransaction[]
  wallet                       Wallet?
  creditReports                CreditReport[]

  @@map("users")
}

model Wallet {
  id                     String              @id @default(cuid())
  userId                 String              @unique
  balance                Float               @default(0)
  availableForWithdrawal Float               @default(0)
  totalDeposits          Float               @default(0)
  totalWithdrawals       Float               @default(0)
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  transactions           WalletTransaction[]
  user                   User                @relation(fields: [userId], references: [id])

  @@map("wallets")
}

model WalletTransaction {
  id          String                  @id @default(cuid())
  userId      String
  walletId    String
  loanId      String?
  type        String
  amount      Float
  description String
  reference   String?
  metadata    Json?
  processedAt DateTime?
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  status      WalletTransactionStatus @default(PENDING)
  loan        Loan?                   @relation(fields: [loanId], references: [id])
  user        User                    @relation(fields: [userId], references: [id])
  wallet      Wallet                  @relation(fields: [walletId], references: [id])

  @@map("wallet_transactions")
}

model Loan {
  id                     String              @id @default(cuid())
  userId                 String
  applicationId          String              @unique
  principalAmount        Float
  outstandingBalance     Float
  interestRate           Float
  term                   Int
  monthlyPayment         Float
  nextPaymentDue         DateTime?
  status                 String              @default("ACTIVE")
  disbursedAt            DateTime?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  dischargedAt           DateTime?
  totalAmount            Float
  calculationMethod      String?
  customDueDate          Int?
  prorationCutoffDate    Int?
  scheduleType           String?
  agreementSignedAt      DateTime?
  agreementStatus        String?
  docusealSubmissionId   String?
  docusealSignUrl        String?
  defaultNoticesSent     Int                 @default(0)
  defaultRiskFlaggedAt   DateTime?
  defaultedAt            DateTime?
  pkiSignedPdfUrl        String?
  pkiStampedPdfUrl       String?
  pkiStampCertificateUrl String?
  lateFee                LateFee?
  defaultLogs            LoanDefaultLog[]
  repayments             LoanRepayment[]
  signatories            LoanSignatory[]
  application            LoanApplication     @relation(fields: [applicationId], references: [id])
  user                   User                @relation(fields: [userId], references: [id])
  walletTransactions     WalletTransaction[]

  @@map("loans")
}

model LoanRepayment {
  id                String           @id @default(cuid())
  loanId            String
  amount            Float
  principalAmount   Float
  interestAmount    Float
  status            String           @default("PENDING")
  dueDate           DateTime
  paidAt            DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  actualAmount      Float?
  daysEarly         Int?             @default(0)
  daysLate          Int?             @default(0)
  installmentNumber Int?
  parentRepaymentId String?
  paymentType       String?
  scheduledAmount   Float?
  lateFeeAmount     Float            @default(0)
  lateFeesPaid      Float            @default(0)
  principalPaid     Float            @default(0)
  loan              Loan             @relation(fields: [loanId], references: [id])
  parentRepayment   LoanRepayment?   @relation("PartialPayments", fields: [parentRepaymentId], references: [id])
  partialPayments   LoanRepayment[]  @relation("PartialPayments")
  receipts          PaymentReceipt[]

  @@index([installmentNumber])
  @@index([paymentType])
  @@index([status, dueDate])
  @@index([loanId, dueDate])
  @@map("loan_repayments")
}

model LoanApplication {
  id                            String                   @id @default(cuid())
  userId                        String
  productId                     String
  amount                        Float?
  term                          Int?
  status                        String                   @default("INCOMPLETE")
  createdAt                     DateTime                 @default(now())
  updatedAt                     DateTime                 @updatedAt
  acceptTerms                   Boolean                  @default(false)
  appStep                       Int                      @default(0)
  applicationFee                Float?
  interestRate                  Float?
  lateFee                       Float?
  legalFee                      Float?
  monthlyRepayment              Float?
  netDisbursement               Float?
  originationFee                Float?
  paidAppFee                    Boolean                  @default(false)
  purpose                       String?
  urlLink                       String?                  @unique
  attestationCompleted          Boolean                  @default(false)
  attestationDate               DateTime?
  attestationNotes              String?
  attestationTermsAccepted      Boolean                  @default(false)
  attestationType               String?
  attestationVideoWatched       Boolean                  @default(false)
  meetingCompletedAt            DateTime?
  meetingScheduledAt            DateTime?
  freshOfferAmount              Float?
  freshOfferInterestRate        Float?
  freshOfferMonthlyRepayment    Float?
  freshOfferNetDisbursement     Float?
  freshOfferNotes               String?
  freshOfferSubmittedAt         DateTime?
  freshOfferSubmittedBy         String?
  freshOfferTerm                Int?
  originalOfferAmount           Float?
  originalOfferInterestRate     Float?
  originalOfferMonthlyRepayment Float?
  originalOfferNetDisbursement  Float?
  originalOfferTerm             Int?
  freshOfferApplicationFee      Float?
  freshOfferLegalFee            Float?
  freshOfferOriginationFee      Float?
  stampingFee                   Float?
  legalFeeFixed                 Float?
  freshOfferStampingFee         Float?
  freshOfferLegalFeeFixed       Float?
  kycSessions                   KycSession[]
  history                       LoanApplicationHistory[]
  creditReportLogs              CreditReportLog[]
  product                       Product                  @relation(fields: [productId], references: [id])
  user                          User                     @relation(fields: [userId], references: [id])
  disbursement                  LoanDisbursement?
  loan                          Loan?
  documents                     UserDocument[]

  @@map("loan_applications")
}

model LoanDisbursement {
  id                String          @id @default(cuid())
  applicationId     String          @unique
  referenceNumber   String
  amount            Float
  bankName          String?
  bankAccountNumber String?
  disbursedAt       DateTime        @default(now())
  disbursedBy       String
  notes             String?
  status            String          @default("COMPLETED")
  paymentSlipUrl    String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  application       LoanApplication @relation(fields: [applicationId], references: [id])

  @@map("loan_disbursements")
}

model UserDocument {
  id            String           @id @default(cuid())
  userId        String
  applicationId String?
  type          String
  status        String           @default("PENDING")
  fileUrl       String
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  application   LoanApplication? @relation(fields: [applicationId], references: [id])
  user          User             @relation(fields: [userId], references: [id])

  @@map("user_documents")
}

model NotificationTemplate {
  id           String           @id @default(cuid())
  code         String           @unique
  title        String
  message      String
  type         NotificationType
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  Notification Notification[]

  @@map("notification_templates")
}

model Notification {
  id         String                @id @default(cuid())
  userId     String
  title      String
  message    String
  isRead     Boolean               @default(false)
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  expiresAt  DateTime?
  metadata   Json?
  priority   NotificationPriority  @default(LOW)
  templateId String?
  type       NotificationType
  link       String?
  template   NotificationTemplate? @relation(fields: [templateId], references: [id])
  user       User                  @relation(fields: [userId], references: [id])

  @@map("notifications")
}

model NotificationGroup {
  id          String   @id @default(cuid())
  name        String
  description String?
  filters     Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("notification_groups")
}

model LoanApplicationHistory {
  id             String          @id @default(cuid())
  applicationId  String
  previousStatus String?
  newStatus      String
  changedBy      String
  changeReason   String?
  notes          String?
  metadata       Json?
  createdAt      DateTime        @default(now())
  application    LoanApplication @relation(fields: [applicationId], references: [id])

  @@map("loan_application_history")
}

model LateFee {
  id                    String   @id @default(cuid())
  status                String   @default("ACTIVE")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  calculationDetails    Json?
  lastCalculationDate   DateTime @default(now())
  loanId                String   @unique
  totalAccruedFees      Float    @default(0)
  gracePeriodDays       Int?
  gracePeriodRepayments Int      @default(0)
  totalGracePeriodFees  Float    @default(0)
  loan                  Loan     @relation(fields: [loanId], references: [id])

  @@index([lastCalculationDate])
  @@index([status])
  @@index([gracePeriodRepayments])
  @@map("late_fees")
}

model LateFeeProcessingLog {
  id                 String   @id @default(cuid())
  processedAt        DateTime @default(now())
  feesCalculated     Int      @default(0)
  totalFeeAmount     Float    @default(0)
  overdue_repayments Int      @default(0)
  status             String
  errorMessage       String?
  processingTimeMs   Int?
  metadata           Json?
  createdAt          DateTime @default(now())

  @@index([processedAt])
  @@map("late_fee_processing_logs")
}

model PhoneVerification {
  id          String   @id @default(cuid())
  userId      String
  phoneNumber String
  otp         String
  expiresAt   DateTime
  verified    Boolean  @default(false)
  attempts    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  otpType     String   @default("PHONE_VERIFICATION")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phoneNumber])
  @@index([expiresAt])
  @@index([userId, verified])
  @@index([phoneNumber, otpType])
  @@map("phone_verifications")
}

model PhoneChangeRequest {
  id              String   @id @default(cuid())
  userId          String
  currentPhone    String
  newPhone        String
  currentVerified Boolean  @default(false)
  newVerified     Boolean  @default(false)
  changeToken     String   @unique
  expiresAt       DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([changeToken])
  @@index([expiresAt])
  @@map("phone_change_requests")
}

model SystemSettings {
  id                   String    @id @default(cuid())
  key                  String    @unique
  category             String
  name                 String
  description          String
  dataType             String
  value                String
  options              Json?
  isActive             Boolean   @default(true)
  requiresRestart      Boolean   @default(false)
  affectsExistingLoans Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  lastChangedBy        String?
  lastChangedAt        DateTime?

  @@map("system_settings")
}

/// KYC session for e-KYC processing
model KycSession {
  id                String           @id @default(cuid())
  userId            String
  applicationId     String?
  status            String           @default("PENDING")
  ocrData           Json?
  faceMatchScore    Float?
  livenessScore     Float?
  retryCount        Int              @default(0)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  completedAt       DateTime?
  ctosData          Json?
  ctosExpiredAt     DateTime?
  ctosOnboardingId  String?
  ctosOnboardingUrl String?
  ctosResult        Int?
  ctosStatus        Int?
  documents         KycDocument[]
  application       LoanApplication? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([applicationId])
  @@index([ctosOnboardingId])
  @@map("kyc_sessions")
}

/// KYC documents associated with a session
model KycDocument {
  id         String     @id @default(cuid())
  kycId      String
  type       String
  storageUrl String
  hashSha256 String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @default(now()) @updatedAt
  kycSession KycSession @relation(fields: [kycId], references: [id], onDelete: Cascade)

  @@unique([kycId, type], name: "kycId_type")
  @@index([kycId])
  @@map("kyc_documents")
}

model BankAccount {
  id            String   @id @default(cuid())
  bankName      String
  accountName   String
  accountNumber String
  isActive      Boolean  @default(true)
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?

  @@map("bank_accounts")
}

/// Log of sent notifications to prevent duplicates
model NotificationLog {
  id               String   @id @default(cuid())
  notificationKey  String
  messageId        String?
  status           String   @default("SENT")
  notificationType String
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([notificationKey])
  @@index([createdAt])
  @@index([notificationType])
  @@map("notification_logs")
}

/// Payment receipts generated for loan repayments
model PaymentReceipt {
  id            String        @id @default(cuid())
  repaymentId   String
  receiptNumber String        @unique
  filePath      String
  fileUrl       String?
  generatedBy   String
  generatedAt   DateTime      @default(now())
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  repayment     LoanRepayment @relation(fields: [repaymentId], references: [id], onDelete: Cascade)

  @@index([receiptNumber])
  @@index([generatedAt])
  @@index([repaymentId])
  @@map("payment_receipts")
}

/// Company settings for receipt generation and signing configuration
model CompanySettings {
  id             String   @id @default(cuid())
  companyName    String   @default("Kredit.my")
  companyAddress String   @default("Kuala Lumpur, Malaysia")
  companyRegNo   String?
  contactPhone   String?
  contactEmail   String?
  footerNote     String?
  taxLabel       String   @default("SST 6%")
  companyLogo    String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String?
  licenseNo      String?
  
  // Signing configuration (for digital signature attestation)
  signUrl        String?  // DocuSeal/signing URL (e.g., https://sign.creditxpress.com.my)
  serverPublicIp String?  // Server public IP for attestation (e.g., 210.186.80.101)

  @@map("company_settings")
}

/// Individual loan signatory tracking
model LoanSignatory {
  id                  String    @id @default(cuid())
  loanId              String
  signatoryType       String
  name                String
  email               String
  role                String
  status              String    @default("PENDING")
  signedAt            DateTime?
  docusealSubmitterId String?
  docusealUuid        String?
  signingUrl          String?
  slug                String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  signingSlug         String?
  loan                Loan      @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@unique([loanId, signatoryType])
  @@index([loanId])
  @@index([status])
  @@index([signatoryType])
  @@map("loan_signatories")
}

model LoanDefaultLog {
  id                String   @id @default(cuid())
  loanId            String
  eventType         String
  daysOverdue       Int
  outstandingAmount Float
  totalLateFees     Float
  noticeType        String?
  whatsappMessageId String?
  pdfLetterPath     String?
  metadata          Json?
  processedAt       DateTime
  createdAt         DateTime @default(now())
  loan              Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([loanId])
  @@index([eventType])
  @@index([processedAt])
  @@map("loan_default_logs")
}

enum WalletTransactionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  SYSTEM
  MARKETING
  FRESH_OFFER
  FRESH_OFFER_RESPONSE
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
}

enum LoanCalculationMethod {
  PROPORTIONAL
  RULE_OF_78
  FIXED_30_DAY
}

enum PaymentScheduleType {
  FIRST_OF_MONTH
  EXACT_MONTHLY
  CUSTOM_DAY
}

/// Admin access log for audit purposes
model AdminAccessLog {
  id               String    @id @default(cuid())
  userId           String
  userName         String
  phoneNumber      String
  userRole         String
  ipAddress        String?
  userAgent        String?
  loginTimestamp   DateTime  @default(now())
  sessionDuration  Int?
  logoutTimestamp  DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([userId])
  @@index([userRole])
  @@index([loginTimestamp])
  @@index([phoneNumber])
  @@map("admin_access_logs")
}

/// Document audit log for tracking file storage
model DocumentAuditLog {
  id              String    @id @default(cuid())
  filePath        String
  fileName        String
  fileSize        Int
  fileType        String
  documentType    String
  userId          String?
  userName        String?
  loanId          String?
  applicationId   String?
  uploadedAt      DateTime
  discoveredAt    DateTime  @default(now())
  isOrphaned      Boolean   @default(false)
  source          String
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([loanId])
  @@index([applicationId])
  @@index([documentType])
  @@index([uploadedAt])
  @@index([source])
  @@index([isOrphaned])
  @@map("document_audit_logs")
}

/// Credit report data from CTOS B2B
model CreditReport {
  id                String   @id @default(cuid())
  userId            String
  applicationId     String?
  
  // Request metadata
  reportType        String   // "INDIVIDUAL", "COMPANY", "BUSINESS"
  icNumber          String?  // For individuals
  brnNumber         String?  // For companies/businesses
  fullName          String
  
  // CTOS Response Data (store raw JSON + parsed fields)
  rawResponse       Json     // Full CTOS API response
  
  // Key Credit Metrics (parsed from response)
  creditScore       Int?
  dueDiligentIndex  String?  // DDI score
  riskGrade         String?
  summaryStatus     String?
  litigationIndex   String?  // CTOS Litigation Index (0000-9999)
  
  // Error detection fields
  hasDataError      Boolean?  // True if report returned but has no actual data
  errorMessage      String?   // Error message from CTOS or detected condition
  
  // Financial Information
  totalOutstanding  Float?
  activeAccounts    Int?
  defaultedAccounts Int?
  
  // Legal Information
  legalCases        Int?
  bankruptcyRecords Int?
  
  // Two-step process tracking
  ctosRequestId     String?  // Request ID from CTOS API step 1
  requestStatus     String   @default("COMPLETED") // PENDING_REQUEST, PENDING_CONFIRM, COMPLETED, FAILED
  requestedAt       DateTime? // When the initial request was made
  confirmedAt       DateTime? // When the request was confirmed and report fetched
  
  // Timestamps
  fetchedAt         DateTime @default(now())
  fetchedBy         String   // Admin user ID who triggered the request
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  user              User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([applicationId])
  @@index([icNumber])
  @@index([ctosRequestId])
  @@index([requestStatus])
  @@map("credit_reports")
}

/// Audit log for credit report fetches
model CreditReportLog {
  id            String   @id @default(cuid())
  applicationId String
  userId        String
  reportId      String?  // Links to CreditReport if successful
  
  action        String   // "FETCH_REQUESTED", "FETCH_SUCCESS", "FETCH_FAILED"
  status        String   // "SUCCESS", "FAILED"
  errorMessage  String?
  
  requestedBy   String   // Admin user ID
  requestedByName String? // Admin full name
  
  metadata      Json?    // Additional context
  createdAt     DateTime @default(now())
  
  application   LoanApplication @relation(fields: [applicationId], references: [id])
  
  @@index([applicationId])
  @@index([userId])
  @@index([requestedBy])
  @@index([createdAt])
  @@map("credit_report_logs")
}

/// Internal users with digital signing certificates (admins, attestors, witnesses)
model InternalSigner {
  id                String    @id @default(cuid())
  
  // User identity - may or may not be linked to User table
  userId            String?   // Optional reference to User.id if user exists in system
  icNumber          String    @unique  // IC number (cert tied to this)
  fullName          String
  email             String
  phoneNumber       String?
  signerRole        String    // ADMIN, ATTESTOR, WITNESS, COMPANY_REP
  
  // Certificate info (cached from MTSA GetCertInfo)
  certSerialNo      String?
  certStatus        String?   // Valid, Expired, Revoked (from MTSA)
  certValidFrom     DateTime?
  certValidTo       DateTime?
  lastCertCheck     DateTime?
  
  // Verification status
  status            String    @default("PENDING")  // PENDING, VERIFIED, EXPIRED, REVOKED, INACTIVE
  pinVerifiedAt     DateTime? // When PIN was last verified
  
  // Enrollment tracking
  enrolledAt        DateTime?
  enrolledBy        String?   // IC/name of admin who added them
  
  // Notes
  notes             String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([icNumber])
  @@index([status])
  @@index([signerRole])
  @@map("internal_signers")
}



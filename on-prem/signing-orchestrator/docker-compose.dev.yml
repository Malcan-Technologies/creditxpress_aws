services:
  signing-orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: signing-orchestrator-dev
    restart: unless-stopped
    ports:
      - "4010:4010"
    env_file:
      - ./env.development
    environment:
      # Application Settings
      - APP_PORT=4010
      - APP_BASE_URL=http://192.168.0.100:3001
      - NODE_ENV=development
      
      # DocuSeal Integration (will be overridden by env.development file)
      # - DOCUSEAL_BASE_URL=${DOCUSEAL_BASE_URL:-http://host.docker.internal:3001}
      # - DOCUSEAL_WEBHOOK_HMAC_SECRET=${DOCUSEAL_WEBHOOK_HMAC_SECRET:-dev-secret-key}
      # - DOCUSEAL_API_TOKEN=${DOCUSEAL_API_TOKEN}
      
      # PKI Integration Settings
      - PKI_ENABLED=${PKI_ENABLED:-true}
      - PKI_SESSION_EXPIRY_MINUTES=${PKI_SESSION_EXPIRY_MINUTES:-10}
      - PKI_OTP_MAX_ATTEMPTS=${PKI_OTP_MAX_ATTEMPTS:-3}
      
      # File Storage
      - SIGNED_FILES_DIR=/data/signed
      - MAX_UPLOAD_MB=50
      
      # MyTrustSigner Agent Configuration (loaded from env.development)
      # - MTSA_ENV, MTSA_WSDL_PILOT, MTSA_WSDL_PROD, MTSA_SOAP_USERNAME, MTSA_SOAP_PASSWORD
      
      # Timezone & Localization
      - KUALA_LUMPUR_TZ=Asia/Kuala_Lumpur
      - TZ=Asia/Kuala_Lumpur
      
      # Network & Performance
      - OUTBOUND_TIMEOUT_MS=30000
      - RETRY_BACKOFF_MS=1000
      - RETRY_MAX=2
      
      # Security (Relaxed for development)
      - CORS_ORIGINS=http://localhost:3000,http://192.168.0.100:3001,http://localhost:4010
      - RATE_LIMIT_WINDOW_MS=60000
      - RATE_LIMIT_MAX_REQUESTS=1000
      
      # Logging (Verbose for development)
      - LOG_LEVEL=debug
      - LOG_FORMAT=pretty
      
      # Template Coordinates (Development templates)
      - SIGNATURE_COORDINATES={"dev-template-1":{"pageNo":1,"x1":100,"y1":200,"x2":300,"y2":250}}
    
    volumes:
      # Development volumes
      - ./data/signed:/data/signed
      - ./logs:/var/log/signing-orchestrator
      # Mount source code for development (if using ts-node-dev)
      - ./src:/app/src:ro
      - ./package.json:/app/package.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
    
    networks:
      - dev-network
    
    depends_on:
      - mtsa-pilot-dev
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Mock MyTrustSigner Agent for Development
  mtsa-pilot-dev:
    image: mockserver/mockserver:latest
    container_name: mtsa-pilot-dev
    restart: unless-stopped
    ports:
      - "8080:1080"
    environment:
      - MOCKSERVER_PROPERTY_FILE=/config/mockserver.properties
      - MOCKSERVER_INITIALIZATION_JSON_PATH=/config/mtsa-mock.json
    volumes:
      - ./dev/mock-mtsa:/config
    networks:
      - dev-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  dev-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
